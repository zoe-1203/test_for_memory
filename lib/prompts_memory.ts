// 记忆提取相关 Prompt（原 YAML 汇总）

export const EXTRACT_MEMORY_PROMPT = `
你是一个“信息整理器”，负责提取、整理和添加输入的内容，并形成新的 fact。用 Json 格式输出。
请你优先在已有的 fact 的 value 之后进行添加。如果遇到和现有 fact 明显冲突的情况，则更新 fact。fact 中提到的人物尽量不要删除，如果是确定可以合并才合并。

# 步骤：
## 1. 判断这次占卜对话是否是有关某个人物的提问。
## 2. 使用用户在问题中的称呼来判断这次占卜对话是有关新的人物，还是 facts 里已经有的人物。用户可以有多个女朋友或者男朋友，如果你不确定尽量不要合并人物。人物最多可以有7个。
if 如果是新人物，则在 facts 里另外开辟一个空间存放新的人物相关内容。用 ## 人名 开头。如果称呼不同，可以认为是新人物。不要臆想是对同一人物的不同称呼。
if 如果是已有人物。则加入 facts 里的已有的人物部分。
## 3. if 如果不是人物，则写入 facts 内的【其他】的部分。
**注意！不能同时写入 人物 和其他**
提取对话内容，写入事实性记忆 facts。

## 如何更新？
- 需要结合「### 旧事实 Fact」和新的用户输入，输出新的 fact。不能直接把 facts 完全变成新的。对比新的 fact 和旧的 fact 并选择性保留。

### 事实 facts 写入规则
1. 判断本轮对话内容和用户提问，是否有关某个人物对象，如果是，则放到对应的具体对象段落内。段落以 ## 具体对象名 开头。
2. 只使用**用户自己说和问**的内容作为材料，但不使用原话。因为事实性记忆记录的是：
发生了什么，而不是用户问了什么。
只存入客观事实如用户的行为、周围的环境、用户主动表达的感受、想法。
不要存塔罗师说的话。
使用 用户自己说和问 的内容作为材料，记录发生了什么，比如：
  - 关系定义（用户如何称呼、如何定位和这个人的关系）
  - 用户明确表达的感受或担忧
  - 用户表示的与该对象相关的行为、决定、计划
  - 相关的情境背景（时间、频率、方式等）
  - 当前互动状态或动态
  - 其他和该人物有关内容
3. 不用保留用户的原话，用中性客观语气转述。
4. 不能写塔罗师的解释、推断、预测、建议。不要编撰内容。
5. 不做价值判断（不写“应该”“不应该”）。

## 2. 写入其他记忆
- 其他记忆（非人物类），仅仅是用户诉说的内容只和自己有关时，才存入的内容。比如用户询问自己的运势、内心探索等等。
- 里面也只能存用户实际说过的内容，用中性的语气转述。

## 3. 写入的事实性记忆，人物类和其他类的组织格式：
  - 人物类：以每个稳定称呼的对象为单位（如小明等），每个对象一段。
  - 其他类：和某个人物无关，**只**与用户自身有关、不指向具体他人的内容，比如用户询问运势等等，单独成几段。

格式示例：
## 人物A（用户对其具体的称呼或名字）相关:
...（单独一段）
## 人物B（具体的称呼或名字）相关:
...（单独一段）
## 人物C、...以此类推
## 其他类（可以不写）:
...（可以为空，可以是多段）

---

# 如何更新 占卜概览 tarot_overview
## 占卜概览写入规则
如果有旧的 tarot_overview，则需要和旧的内容做合并。尽量呈现出用户的占卜趋势是否一致，是否存在变化。也可以判断是否有用户的模式出现。
1. 只使用 assistant 的占卜内容（解读回复与塔罗师的追问回复）。
2. 不记录具体塔罗牌名称、星象、不复述整段解读。
3. 不记录具体时间点、战术级建议或操作步骤。
4. 只总结：在若干次占卜中，针对某些议题出现的“方向性趋势”，例如：
  - 在与某人的沟通议题上，提醒放慢节奏、减少冲动。
  - 在行动/消费选择议题上，提醒注意信息真实性、先查证再做决定。
5. 可以按议题分句描述，但整体不超过 200 字。
6. 占卜概览需要随新占卜更新：
  - 若新一轮占卜只是补充原有方向，则合并为更完整的一版。
  - 若新一轮占卜显示明显转向，可以用转折的语气，改写为新的方向。
7. 用中性、描述性的语言，不做宿命式断言。
---
## 输出格式

请以 JSON 格式输出：
{
  "analysisIfNewPerson": "用来分析这次提到的是不是新人物"
  "analysis": "用来分析这次的会话内容，判断是 facts 里没提过的新人物，还是已有的旧人物（记得更新称呼），还是不属于任何人物要放入其他里。如何判断是否是新人物？用户最开始问的问题的信息是最重要的。"
  "analysisIfUpdateExistingFact": "用来分析是在旧的 fact 下面进行添加，还是改动旧的 fact。尽可能保留旧的 fact。尽可能保留已有的人物。"
  "facts": "这里是 fact 全文，分成人物类和其他类，以自然段组织。最大不超过2000字。",
  "tarot_overview": "这里是更新后的占卜概览，不超过 200 字。"
  "dialogue_area": "存放这次对话用户关心的领域是什么。简短几个字描述。"
}

## 输入
### [新增本轮对话数据（含用户和塔罗师的消息对话内容）]
{{this_session_raw}}

### 旧的 facts
facts: \`\`\`{{old_factual_memory}}\`\`\`

### 旧占卜概览 Tarot Overview]
{{old_tarot_overview}}
`;

export const EXTRACT_MEMORY_MARKDOWN_PROMPT = `
请你帮我从对话中提取值得记住的用户的内容，放进 facts 里，facts 上限为2000字。
facts 只存入用户口述的事实，而不存塔罗师说的内容，不要对用户没说的做揣测。
用 markdown 格式输出。

在用户的新的对话内容提取的 fact 和旧的 fact 做一次合并。合并后的内容为2000字以内。
用户可能会询问关于不同人物的内容，记得做区分。如果是新的人物，可以分成多段，用人物名作为段落标题。
用户询问的自己的运势、或者其他的内容可以单独分成一段。

比如：可以说：用户表示自己最近很焦虑。
但不要说：因为用户说自己要考试，所以用户应该很焦虑。

facts 的总长度应该在2000字以内。tarot overview 的总长度应在200字以内。
## 输出格式
# facts: ...（用自然段输出，不要用列表）

# tarot overview: ...(存入对塔罗师说的内容的压缩）

## 输入
### [新增本轮对话数据（含用户和塔罗师的消息对话内容）]
{{this_session_raw}}

### 旧的 facts
facts: \`\`\`{{old_factual_memory}}\`\`\`

### 旧占卜概览 Tarot Overview]
{{old_tarot_overview}}
`;

export const EXTRACT_MEMORY_STAGE1_PROMPT = `
请你帮我从这段对话中提取出值得被记住的关于用户的部分，放进 facts 里。facts 上限为2000字。

注意，塔罗师说的内容可能不是事实，只有用户说的内容才是事实。
facts 只存入用户口述的事实，而不存塔罗师说的内容，不要对用户没说的做揣测。
topic 存入用户这次关心的主题，以及用户关心的人物名等。topic 简单一句话即可。
用 markdown 格式输出。

请你不要做揣测，而只记录事实。
如果提及不同的人物，需要单开一段。

输出格式：
请用自然语言输出，markdown 格式，但不要用list，而是用自然语言段落。

比如：
## facts
...

## topic
...

对话内容：
{{this_session_raw}}
`;

export const EXTRACT_MEMORY_STAGE2_PROMPT = `
请你帮我更新记忆，我需要你把新的事实合并进旧事实内。请你帮我把旧的事实和新的事实进行合并更新。

我的要求是总事实记录不要超过2000字。
并且如果涉及到冲突的部分，请你以新记忆为准。

如果超出了2000字，你需要对要记录的事实进行取舍，有必要时进行少许概括，但保留大部分细节和原意。

请你按照含义适当进行分段。比如提到不同的人物，则可以分为两段。

输出格式：
## facts：
...


旧事实如下：
{{old}}

新的事实如下：
{{facts}}

新事实发生的时间
{{timeInfo}}
`;

